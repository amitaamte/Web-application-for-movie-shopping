DELIMITER //
CREATE PROCEDURE add_movie11(
ident integer,
title varchar(100),
movie_year integer,
director varchar(100),
firstName varchar(50),
lastName varchar(50),
genre varchar(32),
OUT results varchar(200) )
	
start_here:BEGIN
DECLARE genre_id integer;
DECLARE star_id integer;

/* Check if movie already exists in database */
IF (SELECT COUNT(*) FROM movies m WHERE m.title = title) > 0 THEN
/* Movie already exists */
SELECT ("Movie already exists") into results;
LEAVE start_here;
END IF;

/* IF given ID, check if the ID is already in use*/
IF (SELECT COUNT(*) FROM movies m WHERE m.id = ident) > 0 THEN
SELECT ("Movie id already exists") into results;
LEAVE start_here;	
END IF;	

/* Add Movie to DB */
INSERT INTO movies VALUES(ident, title, movie_year, director, null, null);
SELECT ("Movie added successfully!") into results;

/* If ID was autogenerated, put it into ident */
IF ident IS NULL THEN
SELECT LAST_INSERT_ID() INTO ident;
END IF;

/* Set Genre */
/* Check if Genre Exists and Load ID */
IF (SELECT COUNT(*) FROM genres g WHERE g.name = genre) > 0 THEN
SELECT g.id INTO genre_id FROM genres g WHERE g.name = genre;
ELSE
/* If it doesn't exist, create it then load ID */
INSERT INTO genres(name) VALUES(genre);
SELECT LAST_INSERT_ID() INTO genre_id;
END IF;

INSERT INTO genres_in_movies VALUES(genre_id, ident);	

/* Set Star*/

IF lastName IS NULL THEN
/* Only First Name */
IF (SELECT COUNT(*) FROM stars s WHERE s.last_name = firstName) > 0 THEN
SELECT s.id INTO star_id FROM stars s WHERE s.last_name = firstName;
ELSE
/*Create Star then Add */
INSERT INTO stars(first_name, last_name) VALUES('', firstName);
SELECT LAST_INSERT_ID() INTO star_id;
END IF;
ELSE
IF firstName IS NULL THEN
/* Only Last Name */
IF (SELECT COUNT(*) FROM stars s WHERE s.last_name = lastName) > 0 THEN
SELECT s.id INTO star_id FROM stars s WHERE s.last_name = lastName;
ELSE
/*Create Star Then Add */
INSERT INTO stars(first_name, last_name) VALUES('', lastName);
SELECT LAST_INSERT_ID() INTO star_id;
END IF;
ELSE
/* Both given */
IF (SELECT COUNT(*) FROM stars s WHERE s.first_name = firstName AND s.last_name = lastName) > 0 THEN
SELECT s.id INTO star_id FROM stars s WHERE s.first_name = firstName AND s.last_name = lastName;
ELSE
/* Create Star then Add */
INSERT INTO stars(first_name, last_name) VALUES(firstName, lastName);
SELECT LAST_INSERT_ID() INTO star_id;
END IF;
END IF;
END IF;
INSERT INTO stars_in_movies VALUES(star_id, ident);
	
END//