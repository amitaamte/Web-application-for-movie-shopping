DELIMITER //
CREATE PROCEDURE insert_movies(
	ident integer,
	title varchar(100),
	movie_year integer,
	director varchar(100),
	genre varchar(32),
	)
	
start_here:BEGIN
DECLARE genre_id integer;

/* Check if movie already exists in database */
IF (SELECT COUNT(*) FROM movies m WHERE m.title = title) > 0 THEN
	/* Movie already exists */
	LEAVE start_here;
END IF;

/* IF given ID, check if the ID is already in use*/
IF (SELECT COUNT(*) FROM movies m WHERE m.id = ident) > 0 THEN
	LEAVE start_here;	
END IF;	

/* Add Movie to DB */
INSERT INTO movies VALUES(ident, title, movie_year, director, null, null);

/* If ID was autogenerated, put it into ident */
IF ident IS NULL THEN
	SELECT LAST_INSERT_ID() INTO ident;
END IF;

/* Set Genre */
/* Check if Genre Exists and Load ID */
IF (SELECT COUNT(*) FROM genres g WHERE g.name = genre) > 0 THEN
	SELECT g.id INTO genre_id FROM genres g WHERE g.name = genre;
ELSE
	/* If it doesn't exist, create it then load ID */
	INSERT INTO genres(name) VALUES(genre);
	SELECT LAST_INSERT_ID() INTO genre_id;
END IF;

INSERT INTO genres_in_movies VALUES(genre_id, ident);	


END//